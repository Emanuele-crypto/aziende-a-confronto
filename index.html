<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Settore Agrumi â€” Analisi Comparativa</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg: #07090d;
    --surface: #0d111a;
    --border: rgba(255,255,255,0.07);
    --text: #e8eaf0;
    --muted: #5a6070;
    --dim: #2a2f3d;
    --capua: #e53935;
    --reggina: #7b1fa2;
    --ms: #f57c00;
    --gatto: #2e7d32;
    --corleone: #1565c0;
    --gioia: #00695c;
    --citro: #bf360c;
    --eurofood: #6a1b9a;
  }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Syne', sans-serif;
    min-height: 100vh;
    line-height: 1.5;
  }

  /* â”€â”€ HEADER â”€â”€ */
  header {
    padding: 52px 56px 36px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: flex-end;
    justify-content: space-between;
    gap: 24px;
    flex-wrap: wrap;
  }
  .header-left h1 {
    font-size: clamp(22px, 3vw, 34px);
    font-weight: 800;
    letter-spacing: -0.5px;
    line-height: 1.1;
    color: #fff;
  }
  .header-left h1 span { color: var(--ms); }
  .header-left p {
    margin-top: 8px;
    color: var(--muted);
    font-size: 13px;
    letter-spacing: 0.4px;
  }
  .header-badges {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
  }
  .badge {
    padding: 5px 13px;
    border-radius: 20px;
    font-size: 11px;
    font-weight: 700;
    letter-spacing: 0.5px;
    border: 1px solid;
    cursor: pointer;
    transition: all .2s;
    white-space: nowrap;
  }
  .badge:hover { opacity: 0.8; transform: translateY(-1px); }

  /* â”€â”€ TABS â”€â”€ */
  nav {
    display: flex;
    gap: 0;
    padding: 0 56px;
    border-bottom: 1px solid var(--border);
    overflow-x: auto;
    scrollbar-width: none;
  }
  nav::-webkit-scrollbar { display: none; }
  .tab {
    padding: 16px 22px;
    font-size: 12px;
    font-weight: 700;
    letter-spacing: 0.8px;
    text-transform: uppercase;
    color: var(--muted);
    cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: all .2s;
    white-space: nowrap;
  }
  .tab:hover { color: var(--text); }
  .tab.active { color: #fff; border-bottom-color: var(--ms); }

  /* â”€â”€ MAIN â”€â”€ */
  main { padding: 44px 56px; }
  .panel { display: none; }
  .panel.active { display: block; animation: fadeIn .3s ease; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

  .panel-header { margin-bottom: 32px; }
  .panel-header h2 { font-size: 20px; font-weight: 800; color: #fff; margin-bottom: 6px; }
  .panel-header p { font-size: 12px; color: var(--muted); letter-spacing: 0.3px; }

  /* â”€â”€ CHART CONTAINERS â”€â”€ */
  .chart-wrap {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 28px;
    position: relative;
  }
  .chart-label {
    font-size: 11px;
    font-weight: 700;
    letter-spacing: 0.8px;
    text-transform: uppercase;
    color: var(--muted);
    margin-bottom: 20px;
  }

  .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }
  @media (max-width: 900px) { .two-col { grid-template-columns: 1fr; } }

  /* â”€â”€ INSIGHT BOX â”€â”€ */
  .insight {
    margin-top: 24px;
    padding: 18px 22px;
    border-radius: 10px;
    font-size: 12px;
    line-height: 1.9;
    color: #909aaf;
  }
  .insight.orange { background: rgba(245,124,0,0.07); border: 1px solid rgba(245,124,0,0.2); }
  .insight.green  { background: rgba(46,125,50,0.07); border: 1px solid rgba(46,125,50,0.2); }
  .insight strong { color: #fff; }
  .insight-title { font-size: 12px; font-weight: 800; letter-spacing: 0.6px; margin-bottom: 8px; }

  /* â”€â”€ RADAR PANEL â”€â”€ */
  .radar-grid { display: grid; grid-template-columns: 480px 1fr; gap: 32px; align-items: start; }
  @media (max-width: 1100px) { .radar-grid { grid-template-columns: 1fr; } }

  /* â”€â”€ COMPARISON TABLE â”€â”€ */
  .comp-table { width: 100%; border-collapse: collapse; font-size: 11px; }
  .comp-table th {
    padding: 8px 10px;
    font-size: 10px;
    font-weight: 800;
    letter-spacing: 0.8px;
    text-transform: uppercase;
    text-align: left;
    border-bottom: 1px solid var(--border);
  }
  .comp-table td {
    padding: 8px 10px;
    border-bottom: 1px solid rgba(255,255,255,0.03);
    font-family: 'JetBrains Mono', monospace;
    font-size: 11px;
  }
  .comp-table tr:nth-child(odd) td { background: rgba(255,255,255,0.015); }

  /* â”€â”€ FOOTER TABLE â”€â”€ */
  .footer-section {
    margin-top: 56px;
    padding-top: 36px;
    border-top: 1px solid var(--border);
  }
  .footer-section h3 {
    font-size: 13px;
    font-weight: 800;
    letter-spacing: 0.8px;
    text-transform: uppercase;
    color: var(--muted);
    margin-bottom: 20px;
  }
  .big-table { width: 100%; border-collapse: collapse; font-size: 12px; overflow-x: auto; display: block; }
  .big-table th {
    padding: 10px 14px;
    font-size: 10px;
    font-weight: 800;
    letter-spacing: 0.8px;
    text-transform: uppercase;
    color: var(--muted);
    text-align: left;
    border-bottom: 1px solid var(--border);
    white-space: nowrap;
  }
  .big-table td {
    padding: 12px 14px;
    border-bottom: 1px solid rgba(255,255,255,0.03);
    white-space: nowrap;
  }
  .big-table tr:nth-child(odd) td { background: rgba(255,255,255,0.01); }
  .dot { display: inline-block; width: 8px; height: 8px; border-radius: 2px; margin-right: 8px; vertical-align: middle; }
  .mono { font-family: 'JetBrains Mono', monospace; }
  .pos { color: #4caf50; }
  .neg { color: #ef5350; }
  .footnote { font-size: 10px; color: var(--muted); margin-top: 12px; }

  /* â”€â”€ DETAIL CARD â”€â”€ */
  .detail-overlay {
    display: none;
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.75);
    z-index: 100;
    align-items: center;
    justify-content: center;
  }
  .detail-overlay.open { display: flex; }
  .detail-card {
    background: #0f1420;
    border: 1px solid rgba(255,255,255,0.12);
    border-radius: 18px;
    padding: 36px;
    width: 480px;
    max-width: 95vw;
    position: relative;
    animation: popIn .25s cubic-bezier(.34,1.56,.64,1);
  }
  @keyframes popIn { from { opacity:0; transform: scale(.92); } to { opacity:1; transform: scale(1); } }
  .detail-close {
    position: absolute; top: 16px; right: 16px;
    width: 28px; height: 28px;
    border-radius: 50%;
    background: rgba(255,255,255,0.08);
    border: none;
    color: #fff;
    font-size: 16px;
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
  }
  .detail-name { font-size: 22px; font-weight: 800; margin-bottom: 4px; }
  .detail-meta { font-size: 12px; color: var(--muted); margin-bottom: 24px; }
  .detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
  .metric-box {
    background: rgba(255,255,255,0.04);
    border-radius: 10px;
    padding: 14px 16px;
  }
  .metric-box .label { font-size: 10px; font-weight: 700; letter-spacing: 0.6px; text-transform: uppercase; color: var(--muted); margin-bottom: 4px; }
  .metric-box .value { font-size: 18px; font-weight: 800; font-family: 'JetBrains Mono', monospace; }
</style>
</head>
<body>

<!-- DETAIL OVERLAY -->
<div class="detail-overlay" id="detailOverlay">
  <div class="detail-card">
    <button class="detail-close" onclick="closeDetail()">âœ•</button>
    <div class="detail-name" id="dc-name"></div>
    <div class="detail-meta" id="dc-meta"></div>
    <div class="detail-grid" id="dc-grid"></div>
  </div>
</div>

<!-- HEADER -->
<header>
  <div class="header-left">
    <h1>Settore <span>Agrumi</span> â€” Sicilia &amp; Calabria</h1>
    <p>Analisi comparativa Â· 8 aziende Â· Dati bilanci 2022â€“2024 Â· Fonti pubbliche</p>
  </div>
  <div class="header-badges" id="companyBadges"></div>
</header>

<!-- TABS -->
<nav>
  <div class="tab active" onclick="switchTab('fatturato',this)">Fatturato</div>
  <div class="tab" onclick="switchTab('crescita',this)">Crescita %</div>
  <div class="tab" onclick="switchTab('utile',this)">Utile Netto</div>
  <div class="tab" onclick="switchTab('efficienza',this)">Efficienza Lavoro</div>
  <div class="tab" onclick="switchTab('radar',this)">Radar PMI</div>
</nav>

<!-- PANELS -->
<main>

  <!-- FATTURATO -->
  <div class="panel active" id="panel-fatturato">
    <div class="panel-header">
      <h2>Ricavi Consolidati 2022â€“2024</h2>
      <p>Valori in milioni di euro. Dati 2024 disponibili solo per aziende con bilancio depositato.</p>
    </div>
    <div class="chart-wrap">
      <div class="chart-label">Fatturato (â‚¬M) per anno</div>
      <canvas id="chartFatturato" height="90"></canvas>
    </div>
    <div class="insight orange">
      <div class="insight-title">ðŸ“Š Highlights Fatturato</div>
      <strong>Capua 1880</strong> e <strong>Agrumaria Reggina</strong> superano â‚¬100M nel 2024, guidando il settore in Calabria.<br/>
      <strong>Misitano &amp; Stracuzzi</strong> raggiunge â‚¬72.8M (+25.7%), unica quotata del panel, crescita costante e profittevole.<br/>
      <strong>Eurofood</strong> si posiziona a â‚¬43.5M con solida redditivitÃ  nonostante un lieve calo del fatturato nel 2023.<br/>
      <strong>Simone Gatto</strong> rimane stagnante tra â‚¬28â€“29M dal 2022 â€” struttura dei costi problematica.
    </div>
  </div>

  <!-- CRESCITA -->
  <div class="panel" id="panel-crescita">
    <div class="panel-header">
      <h2>Tassi di Crescita Anno su Anno</h2>
      <p>Variazione percentuale del fatturato. Periodi: 2022â†’2023 e 2023â†’2024.</p>
    </div>
    <div class="two-col">
      <div class="chart-wrap">
        <div class="chart-label">Crescita 2022 â†’ 2023 (%)</div>
        <canvas id="chartCrescita22" height="180"></canvas>
      </div>
      <div class="chart-wrap">
        <div class="chart-label">Crescita 2023 â†’ 2024 (%)</div>
        <canvas id="chartCrescita23" height="180"></canvas>
      </div>
    </div>
    <div class="insight orange">
      <div class="insight-title">ðŸ“ˆ Highlights Crescita</div>
      <strong>Gioia Succhi</strong>: +85% nel 2022â†’23 â€” la piÃ¹ alta tra le PMI, crescita straordinaria per una societÃ  fondata nel 1999.<br/>
      <strong>Agrumaria Reggina</strong>: +71% nel 2022â†’23, +44.9% nel 2023â†’24 â€” espansione sostenuta e continua.<br/>
      <strong>M&amp;S</strong>: crescita costante +21% e +23% â€” il miglior equilibrio tra crescita e redditivitÃ .<br/>
      <strong>Eurofood</strong>: â€“4% nel 2022â†’23 ma EBITDA 16.5% â€” azienda matura che privilegia margini su volume.<br/>
      <strong>Simone Gatto</strong>: â€“1% poi +2% â€” stagnazione strutturale preoccupante.
    </div>
  </div>

  <!-- UTILE -->
  <div class="panel" id="panel-utile">
    <div class="panel-header">
      <h2>Utile Netto Comparato</h2>
      <p>Risultato d'esercizio in milioni di euro. Ultimo anno disponibile per ciascuna azienda.</p>
    </div>
    <div class="chart-wrap">
      <div class="chart-label">Utile netto (â‚¬M) â€” anno piÃ¹ recente disponibile</div>
      <canvas id="chartUtile" height="80"></canvas>
    </div>
    <div class="insight green">
      <div class="insight-title">ðŸ’° Highlights RedditivitÃ </div>
      <strong>M&amp;S</strong>: â‚¬8.92M utile 2024, margine 12.2% â€” best-in-class del settore per efficienza netta.<br/>
      <strong>Gioia Succhi</strong>: â‚¬3.62M utile 2023, margine 15.3% â€” la piÃ¹ redditizia in rapporto al fatturato.<br/>
      <strong>Eurofood</strong>: â‚¬3.24M utile 2023, EBITDA â‚¬7.16M (16.5%) â€” eccellente redditivitÃ  operativa.<br/>
      <strong>Agrumaria Reggina</strong>: â‚¬5.72M utile 2023, margine 8.1% â€” ottima performance in fase di forte crescita.<br/>
      <strong>Simone Gatto</strong>: â€“â‚¬659K perdita 2024 â€” unica azienda del panel in rosso.
    </div>
  </div>

  <!-- EFFICIENZA -->
  <div class="panel" id="panel-efficienza">
    <div class="panel-header">
      <h2>Costi del Lavoro &amp; Efficienza</h2>
      <p>Costo personale assoluto (â‚¬M) e incidenza percentuale sul fatturato (anno 2023).</p>
    </div>
    <div class="two-col">
      <div class="chart-wrap">
        <div class="chart-label">Costo personale assoluto (â‚¬M) â€” 2023</div>
        <canvas id="chartCostoAss" height="200"></canvas>
      </div>
      <div class="chart-wrap">
        <div class="chart-label">Incidenza % costo personale / fatturato â€” 2023</div>
        <canvas id="chartIncidenza" height="200"></canvas>
      </div>
    </div>
    <div class="insight green">
      <div class="insight-title">ðŸ’¡ Analisi Efficienza del Lavoro</div>
      <strong>M&amp;S</strong>: ~6.2% â€” struttura molto automatizzata, la piÃ¹ efficiente del panel.<br/>
      <strong>Capua 1880</strong>: ~6.8% con 164 dipendenti â€” efficienza su grande scala.<br/>
      <strong>Agrumaria Reggina</strong>: ~6.6% â€” ottima gestione anche in forte crescita.<br/>
      <strong>Eurofood</strong>: ~8.3% â€” buona efficienza, EBITDA 16.5%, maturitÃ  industriale dal 1979.<br/>
      <strong>Gioia Succhi</strong>: ~9.4% â€” nella media per una PMI con quel livello di utile (15.3%).<br/>
      <strong>Citrofood</strong>: ~10.9% â€” dimensioni contenute giustificano costi fissi elevati.<br/>
      <strong>Simone Gatto</strong>: ~11.3% â€” il piÃ¹ alto, segnale di struttura meno automatizzata.
    </div>
  </div>

  <!-- RADAR -->
  <div class="panel" id="panel-radar">
    <div class="panel-header">
      <h2>Radar Comparativo â€” PMI del Distretto</h2>
      <p>Indici normalizzati 0â€“100. M&amp;S, Gatto, Gioia, Citrofood, Eurofood a confronto multidimensionale.</p>
    </div>
    <div class="radar-grid">
      <div class="chart-wrap">
        <canvas id="chartRadar" height="120"></canvas>
      </div>
      <div>
        <table class="comp-table">
          <thead>
            <tr>
              <th style="color:var(--muted)">Dimensione</th>
              <th style="color:var(--ms)">M&amp;S</th>
              <th style="color:var(--gatto)">Gatto</th>
              <th style="color:var(--gioia)">Gioia</th>
              <th style="color:var(--citro)">Citrofood</th>
              <th style="color:var(--eurofood)">Eurofood</th>
            </tr>
          </thead>
          <tbody>
            <tr><td style="color:#aaa;font-family:Syne;font-weight:600">Fatturato 2023</td><td style="color:var(--ms)">â‚¬57.5M</td><td style="color:var(--gatto)">â‚¬28.5M</td><td style="color:var(--gioia)">â‚¬23.7M</td><td style="color:var(--citro)">â‚¬17.9M</td><td style="color:var(--eurofood)">â‚¬43.5M</td></tr>
            <tr><td style="color:#aaa;font-family:Syne;font-weight:600">Utile 2023</td><td style="color:var(--ms)">+â‚¬7.08M</td><td style="color:var(--gatto)">n/d</td><td style="color:var(--gioia)">+â‚¬3.62M</td><td style="color:var(--citro)">+â‚¬0.23M</td><td style="color:var(--eurofood)">+â‚¬3.24M</td></tr>
            <tr><td style="color:#aaa;font-family:Syne;font-weight:600">Crescita 22â†’23</td><td class="pos">+21%</td><td class="neg">âˆ’1%</td><td class="pos">+85%</td><td class="pos">+14%</td><td class="neg">âˆ’4%</td></tr>
            <tr><td style="color:#aaa;font-family:Syne;font-weight:600">Costo pers. 2023</td><td style="color:var(--ms)">â‚¬3.58M</td><td style="color:var(--gatto)">â‚¬3.21M</td><td style="color:var(--gioia)">â‚¬2.23M</td><td style="color:var(--citro)">â‚¬1.96M</td><td style="color:var(--eurofood)">â‚¬3.59M</td></tr>
            <tr><td style="color:#aaa;font-family:Syne;font-weight:600">Inc. % personale</td><td style="color:var(--ms)">~6.2%</td><td style="color:var(--gatto)">~11.3%</td><td style="color:var(--gioia)">~9.4%</td><td style="color:var(--citro)">~10.9%</td><td style="color:var(--eurofood)">~8.3%</td></tr>
            <tr><td style="color:#aaa;font-family:Syne;font-weight:600">Dipendenti</td><td style="color:var(--ms)">111</td><td style="color:var(--gatto)">74</td><td style="color:var(--gioia)">~35</td><td style="color:var(--citro)">~30</td><td style="color:var(--eurofood)">50â€“99</td></tr>
            <tr><td style="color:#aaa;font-family:Syne;font-weight:600">Fondazione</td><td style="color:var(--ms)">1922</td><td style="color:var(--gatto)">1922</td><td style="color:var(--gioia)">1999</td><td style="color:var(--citro)">2010</td><td style="color:var(--eurofood)">1979</td></tr>
            <tr><td style="color:#aaa;font-family:Syne;font-weight:600">Regione</td><td style="color:var(--ms)">Sicilia</td><td style="color:var(--gatto)">Sicilia</td><td style="color:var(--gioia)">Calabria</td><td style="color:var(--citro)">Sicilia</td><td style="color:var(--eurofood)">Sicilia</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- FOOTER TABLE -->
  <div class="footer-section">
    <h3>ðŸ“‹ Riepilogo Comparativo Completo</h3>
    <table class="big-table">
      <thead>
        <tr>
          <th>Azienda</th>
          <th>Regione</th>
          <th>Sede</th>
          <th>Fond.</th>
          <th>Fatt. 2024</th>
          <th>Fatt. 2023</th>
          <th>Crescita</th>
          <th>Utile</th>
          <th>Costo Pers.</th>
          <th>Dipendenti</th>
        </tr>
      </thead>
      <tbody id="bigTableBody"></tbody>
    </table>
    <p class="footnote">* costo personale 2023 ove 2024 non disponibile. Fonti: bilanci ufficiali, Registro Imprese, comunicati stampa. Dati 2024 parziali.</p>
  </div>

</main>

<script>
// â”€â”€ DATA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const COMPANIES = [
  { name:"Capua 1880",       short:"Capua",    region:"Calabria", sede:"Campo Calabro (RC)",    fond:1880, settore:"Oli essenziali", f24:108.5, f23:77.5,  f22:74.0, u24:5.10, u23:2.70, cp23:5.30, cp24:5.94, dip:164, color:"#e53935" },
  { name:"Agrumaria Reggina",short:"Reggina",  region:"Calabria", sede:"Reggio Calabria (RC)",  fond:1985, settore:"Succhi & Oli",   f24:101.9, f23:70.3,  f22:41.0, u24:null, u23:5.72, cp23:4.63, cp24:null, dip:80,  color:"#7b1fa2" },
  { name:"Misitano & Stracuzzi",short:"M&S",  region:"Sicilia",  sede:"Messina (ME)",          fond:1922, settore:"Oli essenziali", f24:72.8,  f23:57.5,  f22:47.5, u24:8.92, u23:7.08, cp23:3.58, cp24:4.10, dip:111, color:"#f57c00" },
  { name:"Eurofood",         short:"Eurofood", region:"Sicilia",  sede:"Capo d'Orlando (ME)",   fond:1979, settore:"Succhi & Oli",   f24:null,  f23:43.5,  f22:45.3, u24:null, u23:3.24, cp23:3.59, cp24:null, dip:75,  color:"#6a1b9a" },
  { name:"Simone Gatto",     short:"Gatto",    region:"Sicilia",  sede:"San Pier Niceto (ME)",  fond:1922, settore:"Oli & Succhi",   f24:29.1,  f23:28.5,  f22:28.8, u24:-0.66,u23:null, cp23:3.21, cp24:3.70, dip:74,  color:"#2e7d32" },
  { name:"Gioia Succhi",     short:"Gioia",    region:"Calabria", sede:"San Ferdinando (RC)",   fond:1999, settore:"Succhi agrumi",  f24:null,  f23:23.7,  f22:12.8, u24:null, u23:3.62, cp23:2.23, cp24:null, dip:35,  color:"#00695c" },
  { name:"Agrumaria Corleone",short:"Corleone",region:"Sicilia",  sede:"Palermo (PA)",          fond:1890, settore:"Succhi & Oli",   f24:null,  f23:20.9,  f22:18.0, u24:null, u23:null, cp23:null, cp24:null, dip:35,  color:"#1565c0" },
  { name:"Citrofood",        short:"Citrofood",region:"Sicilia",  sede:"Capo d'Orlando (ME)",   fond:2010, settore:"Succhi & Oli",   f24:null,  f23:17.9,  f22:15.7, u24:null, u23:0.23, cp23:1.96, cp24:null, dip:30,  color:"#bf360c" },
];

// â”€â”€ UTILITY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const fmt = v => v != null ? `â‚¬${v.toFixed(1)}M` : "â€”";
const pct = (a, b) => b != null && a != null ? ((a - b) / b * 100).toFixed(1) : null;
const hex2rgba = (hex, a) => {
  const r = parseInt(hex.slice(1,3),16), g = parseInt(hex.slice(3,5),16), b = parseInt(hex.slice(5,7),16);
  return `rgba(${r},${g},${b},${a})`;
};

const CHART_DEFAULTS = {
  plugins: { legend: { labels: { color:"#8090a8", font:{ family:"Syne", size:11, weight:"700" }, boxWidth:12, padding:18 } }, tooltip: { backgroundColor:"#0d111a", borderColor:"rgba(255,255,255,0.1)", borderWidth:1, titleColor:"#fff", bodyColor:"#8090a8", titleFont:{family:"Syne",weight:"700"}, bodyFont:{family:"JetBrains Mono"}, padding:12 } },
  scales: {
    x: { ticks:{ color:"#5a6070", font:{family:"Syne",size:11} }, grid:{ color:"rgba(255,255,255,0.04)" }, border:{ color:"rgba(255,255,255,0.07)" } },
    y: { ticks:{ color:"#5a6070", font:{family:"JetBrains Mono",size:10} }, grid:{ color:"rgba(255,255,255,0.04)" }, border:{ color:"rgba(255,255,255,0.07)" } }
  }
};

function mergeDeep(...objs) {
  const result = {};
  for (const obj of objs) for (const k in obj) {
    if (obj[k] && typeof obj[k] === 'object' && !Array.isArray(obj[k]))
      result[k] = mergeDeep(result[k] || {}, obj[k]);
    else result[k] = obj[k];
  }
  return result;
}

// â”€â”€ BADGES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const badgeContainer = document.getElementById('companyBadges');
COMPANIES.forEach(c => {
  const b = document.createElement('div');
  b.className = 'badge';
  b.textContent = c.short;
  b.style.color = c.color;
  b.style.borderColor = hex2rgba(c.color, 0.4);
  b.style.background = hex2rgba(c.color, 0.07);
  b.onclick = () => showDetail(c);
  badgeContainer.appendChild(b);
});

// â”€â”€ DETAIL CARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showDetail(c) {
  document.getElementById('dc-name').textContent = c.name;
  document.getElementById('dc-name').style.color = c.color;
  document.getElementById('dc-meta').textContent = `${c.sede} Â· Fondata ${c.fond} Â· ${c.settore}`;
  const g = document.getElementById('dc-grid');
  const u = c.u24 ?? c.u23;
  const uLabel = c.u24 != null ? '2024' : '2023';
  const cp = c.cp24 ?? c.cp23;
  const cpLabel = c.cp24 != null ? '2024' : '2023';
  const f = c.f24 ?? c.f23;
  const fLabel = c.f24 != null ? '2024' : '2023';
  const gr = pct(c.f24 ?? c.f23, c.f23 ?? c.f22);
  g.innerHTML = `
    <div class="metric-box"><div class="label">Fatturato ${fLabel}</div><div class="value" style="color:${c.color}">${fmt(f)}</div></div>
    <div class="metric-box"><div class="label">Utile netto ${uLabel}</div><div class="value" style="color:${u!=null&&u>=0?'#4caf50':'#ef5350'}">${u!=null?`${u>=0?'+':''}â‚¬${Math.abs(u).toFixed(2)}M`:"n/d"}</div></div>
    <div class="metric-box"><div class="label">Costo personale ${cpLabel}</div><div class="value" style="color:#8090a8">${cp!=null?fmt(cp):"n/d"}</div></div>
    <div class="metric-box"><div class="label">Dipendenti</div><div class="value" style="color:#8090a8">${c.dip}</div></div>
    <div class="metric-box"><div class="label">Regione</div><div class="value" style="color:${c.region==='Calabria'?'#e53935':'#f57c00'};font-size:14px">${c.region}</div></div>
    <div class="metric-box"><div class="label">Inc. % personale</div><div class="value" style="color:#8090a8;font-size:14px">${cp!=null&&(c.f23||c.f24)?`~${((cp/(c.f23||c.f24))*100).toFixed(1)}%`:"n/d"}</div></div>
  `;
  document.getElementById('detailOverlay').classList.add('open');
}
function closeDetail() { document.getElementById('detailOverlay').classList.remove('open'); }
document.getElementById('detailOverlay').addEventListener('click', e => { if(e.target===e.currentTarget) closeDetail(); });

// â”€â”€ TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(id, el) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('panel-'+id).classList.add('active');
}

// â”€â”€ CHART 1: FATTURATO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
new Chart(document.getElementById('chartFatturato'), {
  type: 'bar',
  data: {
    labels: COMPANIES.map(c => c.short),
    datasets: [
      { label:'2022', data: COMPANIES.map(c=>c.f22), backgroundColor: COMPANIES.map(c=>hex2rgba(c.color,.3)), borderColor: COMPANIES.map(c=>hex2rgba(c.color,.5)), borderWidth:1, borderRadius:3 },
      { label:'2023', data: COMPANIES.map(c=>c.f23), backgroundColor: COMPANIES.map(c=>hex2rgba(c.color,.55)), borderColor: COMPANIES.map(c=>c.color), borderWidth:1, borderRadius:3 },
      { label:'2024', data: COMPANIES.map(c=>c.f24), backgroundColor: COMPANIES.map(c=>c.color), borderColor: COMPANIES.map(c=>c.color), borderWidth:1, borderRadius:3 },
    ]
  },
  options: mergeDeep({ responsive:true, animation:{duration:600} }, CHART_DEFAULTS, {
    scales: { y:{ ticks:{ callback: v=>`â‚¬${v}M` } } }
  })
});

// â”€â”€ CHART 2: CRESCITA 22-23 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const cr2223 = COMPANIES.map(c => pct(c.f23, c.f22));
new Chart(document.getElementById('chartCrescita22'), {
  type:'bar',
  data: {
    labels: COMPANIES.map(c=>c.short),
    datasets:[{ label:'Crescita 22â†’23 (%)', data: cr2223,
      backgroundColor: cr2223.map((v,i)=> v>=0 ? hex2rgba(COMPANIES[i].color,.7) : 'rgba(239,83,80,.6)'),
      borderColor: cr2223.map((v,i)=> v>=0 ? COMPANIES[i].color : '#ef5350'),
      borderWidth:1, borderRadius:4 }]
  },
  options: mergeDeep({ responsive:true, indexAxis:'y' }, CHART_DEFAULTS, {
    plugins:{ legend:{display:false} },
    scales:{ x:{ ticks:{ callback: v=>`${v>0?'+':''}${v}%` }, grid:{color:"rgba(255,255,255,0.04)"} } }
  })
});

// â”€â”€ CHART 3: CRESCITA 23-24 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const cr2324 = COMPANIES.map(c => pct(c.f24, c.f23));
new Chart(document.getElementById('chartCrescita23'), {
  type:'bar',
  data: {
    labels: COMPANIES.map(c=>c.short),
    datasets:[{ label:'Crescita 23â†’24 (%)', data: cr2324,
      backgroundColor: cr2324.map((v,i)=> v==null?'rgba(255,255,255,0.05)': v>=0 ? hex2rgba(COMPANIES[i].color,.7) : 'rgba(239,83,80,.6)'),
      borderColor: cr2324.map((v,i)=> v==null?'rgba(255,255,255,0.1)': v>=0 ? COMPANIES[i].color : '#ef5350'),
      borderWidth:1, borderRadius:4 }]
  },
  options: mergeDeep({ responsive:true, indexAxis:'y' }, CHART_DEFAULTS, {
    plugins:{ legend:{display:false} },
    scales:{ x:{ ticks:{ callback: v=>`${v>0?'+':''}${v}%` } } }
  })
});

// â”€â”€ CHART 4: UTILE NETTO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const utileData = COMPANIES.map(c => c.u24 ?? c.u23);
new Chart(document.getElementById('chartUtile'), {
  type:'bar',
  data: {
    labels: COMPANIES.map(c=>c.short),
    datasets:[{ label:'Utile netto (â‚¬M)', data: utileData,
      backgroundColor: utileData.map((v,i)=> v==null?'rgba(255,255,255,0.04)': v>=0?hex2rgba(COMPANIES[i].color,.75):'rgba(239,83,80,.6)'),
      borderColor: utileData.map((v,i)=> v==null?'rgba(255,255,255,0.1)': v>=0?COMPANIES[i].color:'#ef5350'),
      borderWidth:1, borderRadius:4 }]
  },
  options: mergeDeep({ responsive:true, animation:{duration:600} }, CHART_DEFAULTS, {
    plugins:{ legend:{display:false} },
    scales:{ y:{ ticks:{ callback: v=>`â‚¬${v}M` } } }
  })
});

// â”€â”€ CHART 5a: COSTO PERSONALE ASSOLUTO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const effCo = COMPANIES.filter(c=>c.cp23!=null);
new Chart(document.getElementById('chartCostoAss'), {
  type:'bar',
  data: {
    labels: effCo.map(c=>c.short),
    datasets:[{ label:'Costo personale (â‚¬M)', data: effCo.map(c=>c.cp23),
      backgroundColor: effCo.map(c=>hex2rgba(c.color,.65)), borderColor: effCo.map(c=>c.color), borderWidth:1, borderRadius:4 }]
  },
  options: mergeDeep({ responsive:true, indexAxis:'y' }, CHART_DEFAULTS, {
    plugins:{legend:{display:false}}, scales:{x:{ticks:{callback:v=>`â‚¬${v}M`}}}
  })
});

// â”€â”€ CHART 5b: INCIDENZA % â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const effIn = COMPANIES.filter(c=>c.cp23!=null && c.f23!=null);
new Chart(document.getElementById('chartIncidenza'), {
  type:'bar',
  data: {
    labels: effIn.map(c=>c.short),
    datasets:[{ label:'% su fatturato', data: effIn.map(c=>((c.cp23/c.f23)*100).toFixed(1)),
      backgroundColor: effIn.map(c=>hex2rgba(c.color,.65)), borderColor: effIn.map(c=>c.color), borderWidth:1, borderRadius:4 }]
  },
  options: mergeDeep({ responsive:true, indexAxis:'y' }, CHART_DEFAULTS, {
    plugins:{legend:{display:false}}, scales:{x:{ticks:{callback:v=>`${v}%`}, max:14}}
  })
});

// â”€â”€ CHART 6: RADAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const pmiNames = ["M&S","Gatto","Gioia","Citrofood","Eurofood"];
const pmiColors = ["#f57c00","#2e7d32","#00695c","#bf360c","#6a1b9a"];
const radarData = {
  labels: ["Fatturato","Crescita","RedditivitÃ ","Dipendenti","Eff. Lavoro","LongevitÃ "],
  datasets: [
    { label:"M&S",      data:[90,95,85,70,80,70], borderColor:pmiColors[0], backgroundColor:hex2rgba(pmiColors[0],.12), borderWidth:2, pointBackgroundColor:pmiColors[0], pointRadius:4 },
    { label:"Gatto",    data:[25,15,5,50,55,70],  borderColor:pmiColors[1], backgroundColor:hex2rgba(pmiColors[1],.12), borderWidth:2, pointBackgroundColor:pmiColors[1], pointRadius:4, borderDash:[5,3] },
    { label:"Gioia",    data:[22,85,70,30,82,15], borderColor:pmiColors[2], backgroundColor:hex2rgba(pmiColors[2],.1),  borderWidth:2, pointBackgroundColor:pmiColors[2], pointRadius:4, borderDash:[4,3] },
    { label:"Citrofood",data:[16,40,30,25,78,10], borderColor:pmiColors[3], backgroundColor:hex2rgba(pmiColors[3],.1),  borderWidth:2, pointBackgroundColor:pmiColors[3], pointRadius:4, borderDash:[3,3] },
    { label:"Eurofood", data:[38,20,65,52,75,80], borderColor:pmiColors[4], backgroundColor:hex2rgba(pmiColors[4],.1),  borderWidth:2, pointBackgroundColor:pmiColors[4], pointRadius:4, borderDash:[6,2] },
  ]
};
new Chart(document.getElementById('chartRadar'), {
  type:'radar',
  data: radarData,
  options: {
    responsive:true,
    scales:{ r:{ min:0, max:100, ticks:{ color:"#3a4050", font:{size:9}, stepSize:25, backdropColor:"transparent" }, grid:{ color:"rgba(255,255,255,0.07)" }, angleLines:{ color:"rgba(255,255,255,0.07)" }, pointLabels:{ color:"#8090a8", font:{family:"Syne",size:11,weight:"700"} } } },
    plugins:{ legend:{ labels:{ color:"#8090a8", font:{family:"Syne",size:11,weight:"700"}, boxWidth:10, padding:16, usePointStyle:true } }, tooltip:{ backgroundColor:"#0d111a", borderColor:"rgba(255,255,255,0.1)", borderWidth:1, titleColor:"#fff", bodyColor:"#8090a8", titleFont:{family:"Syne",weight:"700"}, bodyFont:{family:"JetBrains Mono"}, padding:12 } },
    animation:{duration:700}
  }
});

// â”€â”€ FOOTER TABLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const tbody = document.getElementById('bigTableBody');
COMPANIES.forEach((c,i) => {
  const gr = pct(c.f24??c.f23, c.f23??c.f22);
  const u = c.u24 ?? c.u23;
  const uYear = c.u24!=null?'24':'23';
  const cp = c.cp24 ?? c.cp23;
  const cpYear = c.cp24!=null?'24':'23';
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td><span class="dot" style="background:${c.color}"></span><strong style="color:#fff">${c.name}</strong></td>
    <td style="color:${c.region==='Calabria'?'#e53935':'#f57c00'}">${c.region}</td>
    <td style="color:#5a6070">${c.sede}</td>
    <td class="mono" style="color:#5a6070">${c.fond}</td>
    <td class="mono" style="color:${c.color};font-weight:700">${fmt(c.f24)}</td>
    <td class="mono" style="color:#8090a8">${fmt(c.f23)}</td>
    <td class="mono ${gr!=null?(gr>0?'pos':'neg'):''}">${gr!=null?`${gr>0?'+':''}${gr}%`:"â€”"}</td>
    <td class="mono ${u!=null?(u>=0?'pos':'neg'):''}">${u!=null?`${u>=0?'+':''}â‚¬${Math.abs(u).toFixed(2)}M`:"â€”"}</td>
    <td class="mono" style="color:#8090a8">${cp!=null?`â‚¬${cp.toFixed(2)}M*`:"â€”"}</td>
    <td class="mono" style="color:#8090a8">${c.dip}</td>
  `;
  tbody.appendChild(tr);
});
</script>
</body>
</html>
